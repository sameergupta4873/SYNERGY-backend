const errorHandler = require("../utils/errorHandler");
const catchAsyncErrors = require("../middleware/catchAsyncErrors");
const axios = require("axios");
const { transitiveClosure } = require("./transitiveClosure");

const BASE_URL = "https://api.binance.com/api/v3/ticker";

exports.getMarketData = catchAsyncErrors(async (req, res, next) => {
  const { symbol } = req.body;
  const url = `${BASE_URL}/price/?symbol=${symbol}`;
  try {
    const response = await axios.get(url);
    res.status(200).json(response.data);
  } catch (error) {
    console.error("Error fetching market data:", error);
    next(error);
  }
});

exports.getTransactions = catchAsyncErrors(async (req, res, next) => {
  const { module, action, address, startblock, endblock, page, offset } =
    req.body;
  const url = `https://api.etherscan.io/api?module=${module}&action=${action}&address=${address}&startblock=${startblock}&endblock=${endblock}&page=${page}&offset=${offset}&sort=asc&apikey=S86F1RHCUUZH72TMQ92N1EM1HZEAI46D3H`;
  try {
    const response = await axios.get(url);
    res.status(200).json(response.data);
  } catch (error) {
    console.error("Error fetching transactions:", error);
    next(error);
  }
});

exports.getAnamolyTransactions = catchAsyncErrors(async (req, res, next) => {
  const { module, action, address, startblock, endblock, page, offset } =
    req.body;
  const url = `https://api.etherscan.io/api?module=${module}&action=${action}&address=${address}&startblock=${startblock}&endblock=${endblock}&page=${page}&offset=${offset}&sort=asc&apikey=S86F1RHCUUZH72TMQ92N1EM1HZEAI46D3H`;
  try {
    // const response = await axios.get(url);
    const response={
        "status": "1",
        "message": "OK",
        "result": [
            {
                "blockNumber": "4259813",
                "timeStamp": "1505071724",
                "hash": "0x607eaeeb27afe0e5bacaf020488476844ab9abcfaceafaf2cff458510de23a04",
                "nonce": "464",
                "blockHash": "0x0050d9ad58a59c894a18cf47e28e81b9ea980d2c7d46f8552f00ae3a6d5c14fc",
                "transactionIndex": "31",
                "from": "0x98c5c9dc6dd44d6dc07cbac11df9e0f38594cf42",
                "to": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "value": "91841178427085834",
                "gas": "21000",
                "gasPrice": "21834513098",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x",
                "contractAddress": "",
                "cumulativeGasUsed": "1237380",
                "gasUsed": "21000",
                "confirmations": "15036508",
                "methodId": "0x",
                "functionName": ""
            },
            {
                "blockNumber": "4259822",
                "timeStamp": "1505071855",
                "hash": "0x2df037ae6da450e371ac56ec715598ee7275e491f94adb493be913f47638cab1",
                "nonce": "0",
                "blockHash": "0xf1d043750a2950ec270bee3f0f79c89d92d652576b1dfb92f00af2b63de2056a",
                "transactionIndex": "26",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "0x84119cb33e8f590d75c2d6ea4e6b0741a7494eda",
                "value": "234659839202803",
                "gas": "250000",
                "gasPrice": "4000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x095ea7b30000000000000000000000008d12a197cb00d4747a1fe03395095ce2a5cc681900000000000000000000000000000000000000000000000000000000000002f7",
                "contractAddress": "",
                "cumulativeGasUsed": "1221371",
                "gasUsed": "45206",
                "confirmations": "15036499",
                "methodId": "0x095ea7b3",
                "functionName": "approve(address _spender, uint256 _value)"
            },
            {
                "blockNumber": "4259822",
                "timeStamp": "1505071855",
                "hash": "0xa9e0d6907374a8ca0075cec56c694cc61cbd4c5b49fa12fc30a306c23f34616e",
                "nonce": "1",
                "blockHash": "0xf1d043750a2950ec270bee3f0f79c89d92d652576b1dfb92f00af2b63de2056a",
                "transactionIndex": "30",
                "from": "0x84119cb33e8f590d75c2d6ea4e6b0741a7494eda",
                "to": "0x98c5c9dc6dd44d6dc07cbac11df9e0f38594cflx",
                "value": "0",
                "gas": "250000",
                "gasPrice": "4000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x338b5dea00000000000000000000000084119cb33e8f590d75c2d6ea4e6b0741a7494eda00000000000000000000000000000000000000000000000000000000000002f7",
                "contractAddress": "",
                "cumulativeGasUsed": "1587746",
                "gasUsed": "38357",
                "confirmations": "15036499",
                "methodId": "0x338b5dea",
                "functionName": "depositToken(address token, uint256 amount)"
            },
            {
                "blockNumber": "4259896",
                "timeStamp": "1505073572",
                "hash": "0xab4d20d814db983d374f383cfb452b6ffe092943544f5798a6da8ded47549f0b",
                "nonce": "2",
                "blockHash": "0x55dcc90978a586d8486655784f54f375c0d180248d1dd7629887e6eb644a5189",
                "transactionIndex": "81",
                "from": "0x98c5c9dc6dd44d6dc07cbac11df9e0f38594cflx",
                "to": "0x98c5c9dc6dd44d6dc07cbac11df9e0f38594cf42",
                "value": "0",
                "gas": "603116",
                "gasPrice": "22000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x60a0604052600960608190527f546f6b656e20302e3100000000000000000000000000000000000000000000006080908152600080548180527f546f6b656e20302e310000000000000000000000000000000000000000000012825590927f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563602060026001851615610100026000190190941693909304601f01929092048201929091906100d5565b828001600101855582156100d5579182015b828111156100d55782518255916020019190600101906100ba565b5b506100f69291505b808211156100f257600081556001016100de565b5090565b50503461000057604051610868380380610868833981016040908152815160208301519183015160608401519193928301929091015b33600160a060020a031660009081526005602090815260408220869055600486905584516001805493819052927fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6600282861615610100026000190190921691909104601f9081018490048201938801908390106101b557805160ff19168380011785556101e2565b828001600101855582156101e2579182015b828111156101e25782518255916020019190600101906101c7565b5b506102039291505b808211156100f257600081556001016100de565b5090565b50508060029080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061025157805160ff191683800117855561027e565b8280016001018555821561027e579182015b8281111561027e578251825591602001919060010190610263565b5b5061029f9291505b808211156100f257600081556001016100de565b5090565b50506003805460ff191660ff84161790555b505050505b6105a3806102c56000396000f300606060405236156100725763ffffffff60e060020a60003504166306fdde03811461007757806318160ddd14610104578063313ce567146101235780635a3b7e421461014657806370a08231146101d357806395d89b41146101fe578063a9059cbb1461028b578063dd62ed3e146102a9575b610000565b34610000576100846102da565b6040805160208082528351818301528351919283929083019185019080838382156100ca575b8051825260208311156100ca57601f1990920191602091820191016100aa565b505050905090810190601f1680156100f65780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3461000057610111610367565b60408051918252519081900360200190f35b346100005761013061036d565b6040805160ff9092168252519081900360200190f35b3461000057610084610376565b6040805160208082528351818301528351919283929083019185019080838382156100ca575b8051825260208311156100ca57601f1990920191602091820191016100aa565b505050905090810190601f1680156100f65780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3461000057610111600160a060020a0360043516610404565b60408051918252519081900360200190f35b3461000057610084610416565b6040805160208082528351818301528351919283929083019185019080838382156100ca575b8051825260208311156100ca57601f1990920191602091820191016100aa565b505050905090810190601f1680156100f65780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34610000576102a7600160a060020a03600435166024356104a1565b005b3461000057610111600160a060020a036004358116906024351661055a565b60408051918252519081900360200190f35b60018054604080516020600284861615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561035f5780601f106103345761010080835404028352916020019161035f565b820191906000526020600020905b81548152906001019060200180831161034257829003601f168201915b505050505081565b60045481565b60035460ff1681565b6000805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561035f5780601f106103345761010080835404028352916020019161035f565b820191906000526020600020905b81548152906001019060200180831161034257829003601f168201915b505050505081565b60056020526000908152604090205481565b6002805460408051602060018416156101000260001901909316849004601f8101849004840282018401909252818152929183018282801561035f5780601f106103345761010080835404028352916020019161035f565b820191906000526020600020905b81548152906001019060200180831161034257829003601f168201915b505050505081565b600160a060020a033316600090815260056020526040902054819010156104c757610000565b600160a060020a03821660009081526005602052604090205481810110156104ee57610000565b600160a060020a03338116600081815260056020908152604080832080548790039055938616808352918490208054860190558351858152935191937fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef929081900390910190a35b5050565b6006602090815260009283526040808420909152908252902054815600a165627a7a72305820220ca6f7af6bb8f1b75088455607edb3182b12a2d6293d2640ebfeffbca9d156002900000000000000000000000000000000000000000000000000000000009896800000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000003465544000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034655440000000000000000000000000000000000000000000000000000000000",
                "contractAddress": "0xf9b0a119574190d2e2796662ff05e79300a0fcca",
                "cumulativeGasUsed": "3594865",
                "gasUsed": "603115",
                "confirmations": "15036425",
                "methodId": "0x60a06040",
                "functionName": ""
            },
            {
                "blockNumber": "4259931",
                "timeStamp": "1505074244",
                "hash": "0xa3bfeeef8bae97ab5901d832b5d35b5cb0d0ae23e25f53b6fc9d08d9fc29731b",
                "nonce": "3",
                "blockHash": "0x7eac1b9d827ae54e60a90a08d9a5ddaf2099d5970bcfb9dabca7c8e09d24ed8b",
                "transactionIndex": "17",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "0x663a25c59059df9143ba5f8084152f83e433528e",
                "value": "10000000000000000",
                "gas": "121001",
                "gasPrice": "22000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x",
                "contractAddress": "",
                "cumulativeGasUsed": "476962",
                "gasUsed": "21000",
                "confirmations": "15036390",
                "methodId": "0x",
                "functionName": ""
            },
            {
                "blockNumber": "4260019",
                "timeStamp": "1505076578",
                "hash": "0x4d664fc7fe0bb7c45534a91080727e019fc1081ca73d0c7911aeb2ab45aff1ad",
                "nonce": "4",
                "blockHash": "0x95b358400c27b3599b604a7db7f65b8e1a3eca4facc597f78b48af0fe1a16e3f",
                "transactionIndex": "20",
                "from": "0x663a25c59059df9143ba5f8084152f83e433528e",
                "to": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "value": "0",
                "gas": "889001",
                "gasPrice": "21000000000",
                "isError": "1",
                "txreceipt_status": "",
                "input": "0x60a0604052600460608190527f48312e300000000000000000000000000000000000000000000000000000000060809081526006805460008290527f48312e3000000000000000000000000000000000000000000000000000000008825590927ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f602060026001851615610100026000190190941693909304601f01929092048201929091906100d7565b828001600101855582156100d7579182015b828111156100d75782518255916020019190600101906100bc565b5b506100f89291505b808211156100f457600081556001016100e0565b5090565b505034610000575b33600160a060020a031660009081526020818152604080832063b2d05e00908190556002908155815180830190925260038083527f4c4f4c00000000000000000000000000000000000000000000000000000000009284019283528054948190528251600660ff19909116178155937fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b6001821615610100026000190190911691909104601f019290920482019183916101e2565b828001600101855582156101e2579182015b828111156101e25782518255916020019190600101906101c7565b5b506102039291505b808211156100f457600081556001016100e0565b5090565b50506004805460ff191660029081179091556040805180820190915260038082527f4c4f4c000000000000000000000000000000000000000000000000000000000060209283019081526005805460008290529094601f600019600184161561010002019092160401929092047f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db090810192805160ff19168380011785556102d3565b828001600101855582156102d3579182015b828111156102d35782518255916020019190600101906102b8565b5b506102f49291505b808211156100f457600081556001016100e0565b5090565b50505b5b6109df806103076000396000f300606060405236156100935763ffffffff60e060020a60003504166306fdde0381146100a5578063095ea7b31461013257806318160ddd1461016257806323b872dd14610181578063313ce567146101b757806354fd4d50146101da57806370a082311461026757806395d89b4114610292578063a9059cbb1461031f578063cae9ca511461034f578063dd62ed3e146103c3575b34610000576100a35b610000565b565b005b34610000576100b26103f4565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a0360043516602435610482565b604080519115158252519081900360200190f35b346100005761016f6104ed565b60408051918252519081900360200190f35b346100005761014e600160a060020a03600435811690602435166044356104f3565b604080519115158252519081900360200190f35b34610000576101c46105e7565b6040805160ff9092168252519081900360200190f35b34610000576100b26105f0565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761016f600160a060020a036004351661067e565b60408051918252519081900360200190f35b34610000576100b261069d565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a036004351660243561072b565b604080519115158252519081900360200190f35b3461000057604080516020600460443581810135601f810184900484028501840190955284845261014e948235600160a060020a03169460248035956064949293919092019181908401838280828437509496506107d595505050505050565b604080519115158252519081900360200190f35b346100005761016f600160a060020a0360043581169060243516610986565b60408051918252519081900360200190f35b6003805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a03338116600081815260016020908152604080832094871680845294825280832086905580518681529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a35060015b92915050565b60025481565b600160a060020a0383166000908152602081905260408120548290108015906105435750600160a060020a0380851660009081526001602090815260408083203390941683529290522054829010155b801561054f5750600082115b156105db57600160a060020a0380841660008181526020818152604080832080548801905588851680845281842080548990039055600183528184203390961684529482529182902080548790039055815186815291519293927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9281900390910190a35060016105df565b5060005b5b9392505050565b60045460ff1681565b6006805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0381166000908152602081905260409020545b919050565b6005805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0333166000908152602081905260408120548290108015906107545750600082115b156107c657600160a060020a0333811660008181526020818152604080832080548890039055938716808352918490208054870190558351868152935191937fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef929081900390910190a35060016104e7565b5060006104e7565b5b92915050565b600160a060020a03338116600081815260016020908152604080832094881680845294825280832087905580518781529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a383600160a060020a031660405180807f72656365697665417070726f76616c28616464726573732c75696e743235362c81526020017f616464726573732c627974657329000000000000000000000000000000000000815250602e019050604051809103902060e060020a9004338530866040518563ffffffff1660e060020a0281526004018085600160a060020a0316600160a060020a0316815260200184815260200183600160a060020a0316600160a060020a03168152602001828051906020019080838360008314610927575b80518252602083111561092757601f199092019160209182019101610907565b505050905090810190601f1680156109535780820380516001836020036101000a031916815260200191505b509450505050506000604051808303816000876161da5a03f192505050151561097b57610000565b5060015b9392505050565b600160a060020a038083166000908152600160209081526040808320938516835292905220545b929150505600a165627a7a72305820168b9df5f418bacd17a463aee57d9d1942ea7f90ba20e1d952410fe0bb65353e0029",
                "contractAddress": "0xadad45e84dc04b64a69817f3856862297048fb73",
                "cumulativeGasUsed": "1544173",
                "gasUsed": "889001",
                "confirmations": "15036302",
                "methodId": "0x60a06040",
                "functionName": ""
            },
            {
                "blockNumber": "4260051",
                "timeStamp": "1505077203",
                "hash": "0xc918fae6621c67450562c3d70f44b5f0ba676b5c02361eaf858ba9533d06edcd",
                "nonce": "5",
                "blockHash": "0x4d313ae529d619072132116b5aefb396d5c6a5a61c85598cac40545de969428a",
                "transactionIndex": "13",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "",
                "value": "0",
                "gas": "889922",
                "gasPrice": "22000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x60a0604052600460608190527f48312e300000000000000000000000000000000000000000000000000000000060809081526006805460008290527f48312e3000000000000000000000000000000000000000000000000000000008825590927ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f602060026001851615610100026000190190941693909304601f01929092048201929091906100d7565b828001600101855582156100d7579182015b828111156100d75782518255916020019190600101906100bc565b5b506100f89291505b808211156100f457600081556001016100e0565b5090565b505034610000575b33600160a060020a031660009081526020818152604080832063b2d05e009081905560029081558151808301909252600b8083527f53696e67756c617269747900000000000000000000000000000000000000000092840192835260038054958190528351601660ff19909116178155947fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b6001821615610100026000190190911692909204601f0193909304810192916101e3565b828001600101855582156101e3579182015b828111156101e35782518255916020019190600101906101c8565b5b506102049291505b808211156100f457600081556001016100e0565b5090565b505060048054600260ff1991821681178355604080518082019091528181527f41490000000000000000000000000000000000000000000000000000000000006020918201908152600580546000829052825190951690951785557f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db061010060018616150260001901909416839004601f0191909104830192906102d0565b828001600101855582156102d0579182015b828111156102d05782518255916020019190600101906102b5565b5b506102f19291505b808211156100f457600081556001016100e0565b5090565b50505b5b6109df806103046000396000f300606060405236156100935763ffffffff60e060020a60003504166306fdde0381146100a5578063095ea7b31461013257806318160ddd1461016257806323b872dd14610181578063313ce567146101b757806354fd4d50146101da57806370a082311461026757806395d89b4114610292578063a9059cbb1461031f578063cae9ca511461034f578063dd62ed3e146103c3575b34610000576100a35b610000565b565b005b34610000576100b26103f4565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a0360043516602435610482565b604080519115158252519081900360200190f35b346100005761016f6104ed565b60408051918252519081900360200190f35b346100005761014e600160a060020a03600435811690602435166044356104f3565b604080519115158252519081900360200190f35b34610000576101c46105e7565b6040805160ff9092168252519081900360200190f35b34610000576100b26105f0565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761016f600160a060020a036004351661067e565b60408051918252519081900360200190f35b34610000576100b261069d565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a036004351660243561072b565b604080519115158252519081900360200190f35b3461000057604080516020600460443581810135601f810184900484028501840190955284845261014e948235600160a060020a03169460248035956064949293919092019181908401838280828437509496506107d595505050505050565b604080519115158252519081900360200190f35b346100005761016f600160a060020a0360043581169060243516610986565b60408051918252519081900360200190f35b6003805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a03338116600081815260016020908152604080832094871680845294825280832086905580518681529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a35060015b92915050565b60025481565b600160a060020a0383166000908152602081905260408120548290108015906105435750600160a060020a0380851660009081526001602090815260408083203390941683529290522054829010155b801561054f5750600082115b156105db57600160a060020a0380841660008181526020818152604080832080548801905588851680845281842080548990039055600183528184203390961684529482529182902080548790039055815186815291519293927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9281900390910190a35060016105df565b5060005b5b9392505050565b60045460ff1681565b6006805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0381166000908152602081905260409020545b919050565b6005805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0333166000908152602081905260408120548290108015906107545750600082115b156107c657600160a060020a0333811660008181526020818152604080832080548890039055938716808352918490208054870190558351868152935191937fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef929081900390910190a35060016104e7565b5060006104e7565b5b92915050565b600160a060020a03338116600081815260016020908152604080832094881680845294825280832087905580518781529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a383600160a060020a031660405180807f72656365697665417070726f76616c28616464726573732c75696e743235362c81526020017f616464726573732c627974657329000000000000000000000000000000000000815250602e019050604051809103902060e060020a9004338530866040518563ffffffff1660e060020a0281526004018085600160a060020a0316600160a060020a0316815260200184815260200183600160a060020a0316600160a060020a03168152602001828051906020019080838360008314610927575b80518252602083111561092757601f199092019160209182019101610907565b505050905090810190601f1680156109535780820380516001836020036101000a031916815260200191505b509450505050506000604051808303816000876161da5a03f192505050151561097b57610000565b5060015b9392505050565b600160a060020a038083166000908152600160209081526040808320938516835292905220545b929150505600a165627a7a7230582047c4aa44eddca7cecdf8d17249f73ca7b249b81b2f8d15ac138b4d8be17b16e80029",
                "contractAddress": "0x660db3ed99edb058ce0f6aaece248c430afb4569",
                "cumulativeGasUsed": "1350590",
                "gasUsed": "889921",
                "confirmations": "15036270",
                "methodId": "0x60a06040",
                "functionName": ""
            },
            {
                "blockNumber": "4260071",
                "timeStamp": "1505077574",
                "hash": "0xe78d7f48607fecb60d2f34df3413c0e1eb984e872b82f86567001a4e5c1ea8b0",
                "nonce": "6",
                "blockHash": "0x82c1c7c6c94650dcf4f860881426e22e71b1daa9954106dc4b3320d7275a7b91",
                "transactionIndex": "29",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "0x660db3ed99edb058ce0f6aaece248c430afb4569",
                "value": "0",
                "gas": "151395",
                "gasPrice": "22000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0xa9059cbb000000000000000000000000663a25c59059df9143ba5f8084152f83e433528e000000000000000000000000000000000000000000000000000000001dcd6500",
                "contractAddress": "",
                "cumulativeGasUsed": "1867453",
                "gasUsed": "51394",
                "confirmations": "15036250",
                "methodId": "0xa9059cbb",
                "functionName": "transfer(address _to, uint256 _value)"
            },
            {
                "blockNumber": "4260092",
                "timeStamp": "1505078198",
                "hash": "0x79b19b67924e0c9e631a62193484fd3bb92e02869a65ed992f199765b1fc8d3d",
                "nonce": "7",
                "blockHash": "0xdad74309967f3801bc836d40952947fc188148dc6f8e8983724aa1d4b6f591f0",
                "transactionIndex": "18",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "",
                "value": "0",
                "gas": "899684",
                "gasPrice": "22000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x60a0604052600460608190527f48312e300000000000000000000000000000000000000000000000000000000060809081526006805460008290527f48312e3000000000000000000000000000000000000000000000000000000008825590927ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f602060026001851615610100026000190190941693909304601f01929092048201929091906100d7565b828001600101855582156100d7579182015b828111156100d75782518255916020019190600101906100bc565b5b506100f89291505b808211156100f457600081556001016100e0565b5090565b505034610000575b33600160a060020a031660009081526020818152604080832063b2d05e00908190556002908155815180830190925260038083527f44616900000000000000000000000000000000000000000000000000000000009284019283528054948190528251600660ff19909116178155937fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b6001821615610100026000190190911691909104601f019290920482019183916101e2565b828001600101855582156101e2579182015b828111156101e25782518255916020019190600101906101c7565b5b506102039291505b808211156100f457600081556001016100e0565b5090565b50506004805460ff191660029081179091556040805180820190915260038082527f444149000000000000000000000000000000000000000000000000000000000060209283019081526005805460008290529094601f600019600184161561010002019092160401929092047f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db090810192805160ff19168380011785556102d3565b828001600101855582156102d3579182015b828111156102d35782518255916020019190600101906102b8565b5b506102f49291505b808211156100f457600081556001016100e0565b5090565b50505b5b6109df806103076000396000f300606060405236156100935763ffffffff60e060020a60003504166306fdde0381146100a5578063095ea7b31461013257806318160ddd1461016257806323b872dd14610181578063313ce567146101b757806354fd4d50146101da57806370a082311461026757806395d89b4114610292578063a9059cbb1461031f578063cae9ca511461034f578063dd62ed3e146103c3575b34610000576100a35b610000565b565b005b34610000576100b26103f4565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a0360043516602435610482565b604080519115158252519081900360200190f35b346100005761016f6104ed565b60408051918252519081900360200190f35b346100005761014e600160a060020a03600435811690602435166044356104f3565b604080519115158252519081900360200190f35b34610000576101c46105e7565b6040805160ff9092168252519081900360200190f35b34610000576100b26105f0565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761016f600160a060020a036004351661067e565b60408051918252519081900360200190f35b34610000576100b261069d565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a036004351660243561072b565b604080519115158252519081900360200190f35b3461000057604080516020600460443581810135601f810184900484028501840190955284845261014e948235600160a060020a03169460248035956064949293919092019181908401838280828437509496506107d595505050505050565b604080519115158252519081900360200190f35b346100005761016f600160a060020a0360043581169060243516610986565b60408051918252519081900360200190f35b6003805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a03338116600081815260016020908152604080832094871680845294825280832086905580518681529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a35060015b92915050565b60025481565b600160a060020a0383166000908152602081905260408120548290108015906105435750600160a060020a0380851660009081526001602090815260408083203390941683529290522054829010155b801561054f5750600082115b156105db57600160a060020a0380841660008181526020818152604080832080548801905588851680845281842080548990039055600183528184203390961684529482529182902080548790039055815186815291519293927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9281900390910190a35060016105df565b5060005b5b9392505050565b60045460ff1681565b6006805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0381166000908152602081905260409020545b919050565b6005805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0333166000908152602081905260408120548290108015906107545750600082115b156107c657600160a060020a0333811660008181526020818152604080832080548890039055938716808352918490208054870190558351868152935191937fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef929081900390910190a35060016104e7565b5060006104e7565b5b92915050565b600160a060020a03338116600081815260016020908152604080832094881680845294825280832087905580518781529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a383600160a060020a031660405180807f72656365697665417070726f76616c28616464726573732c75696e743235362c81526020017f616464726573732c627974657329000000000000000000000000000000000000815250602e019050604051809103902060e060020a9004338530866040518563ffffffff1660e060020a0281526004018085600160a060020a0316600160a060020a0316815260200184815260200183600160a060020a0316600160a060020a03168152602001828051906020019080838360008314610927575b80518252602083111561092757601f199092019160209182019101610907565b505050905090810190601f1680156109535780820380516001836020036101000a031916815260200191505b509450505050506000604051808303816000876161da5a03f192505050151561097b57610000565b5060015b9392505050565b600160a060020a038083166000908152600160209081526040808320938516835292905220545b929150505600a165627a7a7230582031edb43f3bd896ec38c1373e442bc11dbf7fa311c4203cd72dd39d67f64c25ed0029",
                "contractAddress": "0xc94a6e7776bade5da316cf6fd8c751fb0d5c3c5e",
                "cumulativeGasUsed": "1480412",
                "gasUsed": "889683",
                "confirmations": "15036229",
                "methodId": "0x60a06040",
                "functionName": ""
            },
            {
                "blockNumber": "4260142",
                "timeStamp": "1505079443",
                "hash": "0x1431bff0bbfb811cb269009c67b557a5d6cfc8508f425d6e997ecd93b8c7af6e",
                "nonce": "8",
                "blockHash": "0xf975ef975e5cdde50ad3a3ba7aa7b08adf4b173746bdd8efbe367a2fd5d67eb0",
                "transactionIndex": "123",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "0xf9b0a119574190d2e2796662ff05e79300a0fcca",
                "value": "0",
                "gas": "51623",
                "gasPrice": "21000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0xa9059cbb000000000000000000000000663a25c59059df9143ba5f8084152f83e433528e0000000000000000000000000000000000000000000000000000000000989680",
                "contractAddress": "",
                "cumulativeGasUsed": "4838989",
                "gasUsed": "36623",
                "confirmations": "15036179",
                "methodId": "0xa9059cbb",
                "functionName": "transfer(address _to, uint256 _value)"
            }
        ]
    }
    const result = response.result;
    const { nodes, edges } = extractInfo(result);
    const allLoops = detectAllLoops(nodes, edges);

    if (allLoops.length > 0) {
      console.log("Loops detected:", allLoops);
    } else {
      console.log("No loops detected");
    }
    res.status(200).json({
      transactions: response.result,
      loops: allLoops,
    });
  } catch (error) {
    console.error("Error fetching transactions:", error);
    next(error);
  }
});

exports.detectAnomaly = catchAsyncErrors(async (req, res, next) => {
  try {
    const { module, action, address, startblock, endblock, page, offset } =
      req.body;
    // const url = `https://api.etherscan.io/api?module=${module}&action=${action}&address=${address}&startblock=${startblock}&endblock=${endblock}&page=${page}&offset=${offset}&sort=asc&apikey=S86F1RHCUUZH72TMQ92N1EM1HZEAI46D3H`;
    // const response = await axios.get(url);
    const response={
        "status": "1",
        "message": "OK",
        "result": [
            {
                "blockNumber": "4259813",
                "timeStamp": "1505071724",
                "hash": "0x607eaeeb27afe0e5bacaf020488476844ab9abcfaceafaf2cff458510de23a04",
                "nonce": "464",
                "blockHash": "0x0050d9ad58a59c894a18cf47e28e81b9ea980d2c7d46f8552f00ae3a6d5c14fc",
                "transactionIndex": "31",
                "from": "0x98c5c9dc6dd44d6dc07cbac11df9e0f38594cf42",
                "to": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "value": "91841178427085834",
                "gas": "21000",
                "gasPrice": "21834513098",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x",
                "contractAddress": "",
                "cumulativeGasUsed": "1237380",
                "gasUsed": "21000",
                "confirmations": "15036508",
                "methodId": "0x",
                "functionName": ""
            },
            {
                "blockNumber": "4259822",
                "timeStamp": "1505071855",
                "hash": "0x2df037ae6da450e371ac56ec715598ee7275e491f94adb493be913f47638cab1",
                "nonce": "0",
                "blockHash": "0xf1d043750a2950ec270bee3f0f79c89d92d652576b1dfb92f00af2b63de2056a",
                "transactionIndex": "26",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "0x84119cb33e8f590d75c2d6ea4e6b0741a7494eda",
                "value": "234659839202803",
                "gas": "250000",
                "gasPrice": "4000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x095ea7b30000000000000000000000008d12a197cb00d4747a1fe03395095ce2a5cc681900000000000000000000000000000000000000000000000000000000000002f7",
                "contractAddress": "",
                "cumulativeGasUsed": "1221371",
                "gasUsed": "45206",
                "confirmations": "15036499",
                "methodId": "0x095ea7b3",
                "functionName": "approve(address _spender, uint256 _value)"
            },
            {
                "blockNumber": "4259822",
                "timeStamp": "1505071855",
                "hash": "0xa9e0d6907374a8ca0075cec56c694cc61cbd4c5b49fa12fc30a306c23f34616e",
                "nonce": "1",
                "blockHash": "0xf1d043750a2950ec270bee3f0f79c89d92d652576b1dfb92f00af2b63de2056a",
                "transactionIndex": "30",
                "from": "0x84119cb33e8f590d75c2d6ea4e6b0741a7494eda",
                "to": "0x98c5c9dc6dd44d6dc07cbac11df9e0f38594cflx",
                "value": "0",
                "gas": "250000",
                "gasPrice": "4000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x338b5dea00000000000000000000000084119cb33e8f590d75c2d6ea4e6b0741a7494eda00000000000000000000000000000000000000000000000000000000000002f7",
                "contractAddress": "",
                "cumulativeGasUsed": "1587746",
                "gasUsed": "38357",
                "confirmations": "15036499",
                "methodId": "0x338b5dea",
                "functionName": "depositToken(address token, uint256 amount)"
            },
            {
                "blockNumber": "4259896",
                "timeStamp": "1505073572",
                "hash": "0xab4d20d814db983d374f383cfb452b6ffe092943544f5798a6da8ded47549f0b",
                "nonce": "2",
                "blockHash": "0x55dcc90978a586d8486655784f54f375c0d180248d1dd7629887e6eb644a5189",
                "transactionIndex": "81",
                "from": "0x98c5c9dc6dd44d6dc07cbac11df9e0f38594cflx",
                "to": "0x98c5c9dc6dd44d6dc07cbac11df9e0f38594cf42",
                "value": "0",
                "gas": "603116",
                "gasPrice": "22000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x60a0604052600960608190527f546f6b656e20302e3100000000000000000000000000000000000000000000006080908152600080548180527f546f6b656e20302e310000000000000000000000000000000000000000000012825590927f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563602060026001851615610100026000190190941693909304601f01929092048201929091906100d5565b828001600101855582156100d5579182015b828111156100d55782518255916020019190600101906100ba565b5b506100f69291505b808211156100f257600081556001016100de565b5090565b50503461000057604051610868380380610868833981016040908152815160208301519183015160608401519193928301929091015b33600160a060020a031660009081526005602090815260408220869055600486905584516001805493819052927fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6600282861615610100026000190190921691909104601f9081018490048201938801908390106101b557805160ff19168380011785556101e2565b828001600101855582156101e2579182015b828111156101e25782518255916020019190600101906101c7565b5b506102039291505b808211156100f257600081556001016100de565b5090565b50508060029080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061025157805160ff191683800117855561027e565b8280016001018555821561027e579182015b8281111561027e578251825591602001919060010190610263565b5b5061029f9291505b808211156100f257600081556001016100de565b5090565b50506003805460ff191660ff84161790555b505050505b6105a3806102c56000396000f300606060405236156100725763ffffffff60e060020a60003504166306fdde03811461007757806318160ddd14610104578063313ce567146101235780635a3b7e421461014657806370a08231146101d357806395d89b41146101fe578063a9059cbb1461028b578063dd62ed3e146102a9575b610000565b34610000576100846102da565b6040805160208082528351818301528351919283929083019185019080838382156100ca575b8051825260208311156100ca57601f1990920191602091820191016100aa565b505050905090810190601f1680156100f65780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3461000057610111610367565b60408051918252519081900360200190f35b346100005761013061036d565b6040805160ff9092168252519081900360200190f35b3461000057610084610376565b6040805160208082528351818301528351919283929083019185019080838382156100ca575b8051825260208311156100ca57601f1990920191602091820191016100aa565b505050905090810190601f1680156100f65780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3461000057610111600160a060020a0360043516610404565b60408051918252519081900360200190f35b3461000057610084610416565b6040805160208082528351818301528351919283929083019185019080838382156100ca575b8051825260208311156100ca57601f1990920191602091820191016100aa565b505050905090810190601f1680156100f65780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34610000576102a7600160a060020a03600435166024356104a1565b005b3461000057610111600160a060020a036004358116906024351661055a565b60408051918252519081900360200190f35b60018054604080516020600284861615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561035f5780601f106103345761010080835404028352916020019161035f565b820191906000526020600020905b81548152906001019060200180831161034257829003601f168201915b505050505081565b60045481565b60035460ff1681565b6000805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561035f5780601f106103345761010080835404028352916020019161035f565b820191906000526020600020905b81548152906001019060200180831161034257829003601f168201915b505050505081565b60056020526000908152604090205481565b6002805460408051602060018416156101000260001901909316849004601f8101849004840282018401909252818152929183018282801561035f5780601f106103345761010080835404028352916020019161035f565b820191906000526020600020905b81548152906001019060200180831161034257829003601f168201915b505050505081565b600160a060020a033316600090815260056020526040902054819010156104c757610000565b600160a060020a03821660009081526005602052604090205481810110156104ee57610000565b600160a060020a03338116600081815260056020908152604080832080548790039055938616808352918490208054860190558351858152935191937fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef929081900390910190a35b5050565b6006602090815260009283526040808420909152908252902054815600a165627a7a72305820220ca6f7af6bb8f1b75088455607edb3182b12a2d6293d2640ebfeffbca9d156002900000000000000000000000000000000000000000000000000000000009896800000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000003465544000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034655440000000000000000000000000000000000000000000000000000000000",
                "contractAddress": "0xf9b0a119574190d2e2796662ff05e79300a0fcca",
                "cumulativeGasUsed": "3594865",
                "gasUsed": "603115",
                "confirmations": "15036425",
                "methodId": "0x60a06040",
                "functionName": ""
            },
            {
                "blockNumber": "4259931",
                "timeStamp": "1505074244",
                "hash": "0xa3bfeeef8bae97ab5901d832b5d35b5cb0d0ae23e25f53b6fc9d08d9fc29731b",
                "nonce": "3",
                "blockHash": "0x7eac1b9d827ae54e60a90a08d9a5ddaf2099d5970bcfb9dabca7c8e09d24ed8b",
                "transactionIndex": "17",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "0x663a25c59059df9143ba5f8084152f83e433528e",
                "value": "10000000000000000",
                "gas": "121001",
                "gasPrice": "22000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x",
                "contractAddress": "",
                "cumulativeGasUsed": "476962",
                "gasUsed": "21000",
                "confirmations": "15036390",
                "methodId": "0x",
                "functionName": ""
            },
            {
                "blockNumber": "4260019",
                "timeStamp": "1505076578",
                "hash": "0x4d664fc7fe0bb7c45534a91080727e019fc1081ca73d0c7911aeb2ab45aff1ad",
                "nonce": "4",
                "blockHash": "0x95b358400c27b3599b604a7db7f65b8e1a3eca4facc597f78b48af0fe1a16e3f",
                "transactionIndex": "20",
                "from": "0x663a25c59059df9143ba5f8084152f83e433528e",
                "to": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "value": "0",
                "gas": "889001",
                "gasPrice": "21000000000",
                "isError": "1",
                "txreceipt_status": "",
                "input": "0x60a0604052600460608190527f48312e300000000000000000000000000000000000000000000000000000000060809081526006805460008290527f48312e3000000000000000000000000000000000000000000000000000000008825590927ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f602060026001851615610100026000190190941693909304601f01929092048201929091906100d7565b828001600101855582156100d7579182015b828111156100d75782518255916020019190600101906100bc565b5b506100f89291505b808211156100f457600081556001016100e0565b5090565b505034610000575b33600160a060020a031660009081526020818152604080832063b2d05e00908190556002908155815180830190925260038083527f4c4f4c00000000000000000000000000000000000000000000000000000000009284019283528054948190528251600660ff19909116178155937fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b6001821615610100026000190190911691909104601f019290920482019183916101e2565b828001600101855582156101e2579182015b828111156101e25782518255916020019190600101906101c7565b5b506102039291505b808211156100f457600081556001016100e0565b5090565b50506004805460ff191660029081179091556040805180820190915260038082527f4c4f4c000000000000000000000000000000000000000000000000000000000060209283019081526005805460008290529094601f600019600184161561010002019092160401929092047f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db090810192805160ff19168380011785556102d3565b828001600101855582156102d3579182015b828111156102d35782518255916020019190600101906102b8565b5b506102f49291505b808211156100f457600081556001016100e0565b5090565b50505b5b6109df806103076000396000f300606060405236156100935763ffffffff60e060020a60003504166306fdde0381146100a5578063095ea7b31461013257806318160ddd1461016257806323b872dd14610181578063313ce567146101b757806354fd4d50146101da57806370a082311461026757806395d89b4114610292578063a9059cbb1461031f578063cae9ca511461034f578063dd62ed3e146103c3575b34610000576100a35b610000565b565b005b34610000576100b26103f4565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a0360043516602435610482565b604080519115158252519081900360200190f35b346100005761016f6104ed565b60408051918252519081900360200190f35b346100005761014e600160a060020a03600435811690602435166044356104f3565b604080519115158252519081900360200190f35b34610000576101c46105e7565b6040805160ff9092168252519081900360200190f35b34610000576100b26105f0565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761016f600160a060020a036004351661067e565b60408051918252519081900360200190f35b34610000576100b261069d565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a036004351660243561072b565b604080519115158252519081900360200190f35b3461000057604080516020600460443581810135601f810184900484028501840190955284845261014e948235600160a060020a03169460248035956064949293919092019181908401838280828437509496506107d595505050505050565b604080519115158252519081900360200190f35b346100005761016f600160a060020a0360043581169060243516610986565b60408051918252519081900360200190f35b6003805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a03338116600081815260016020908152604080832094871680845294825280832086905580518681529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a35060015b92915050565b60025481565b600160a060020a0383166000908152602081905260408120548290108015906105435750600160a060020a0380851660009081526001602090815260408083203390941683529290522054829010155b801561054f5750600082115b156105db57600160a060020a0380841660008181526020818152604080832080548801905588851680845281842080548990039055600183528184203390961684529482529182902080548790039055815186815291519293927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9281900390910190a35060016105df565b5060005b5b9392505050565b60045460ff1681565b6006805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0381166000908152602081905260409020545b919050565b6005805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0333166000908152602081905260408120548290108015906107545750600082115b156107c657600160a060020a0333811660008181526020818152604080832080548890039055938716808352918490208054870190558351868152935191937fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef929081900390910190a35060016104e7565b5060006104e7565b5b92915050565b600160a060020a03338116600081815260016020908152604080832094881680845294825280832087905580518781529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a383600160a060020a031660405180807f72656365697665417070726f76616c28616464726573732c75696e743235362c81526020017f616464726573732c627974657329000000000000000000000000000000000000815250602e019050604051809103902060e060020a9004338530866040518563ffffffff1660e060020a0281526004018085600160a060020a0316600160a060020a0316815260200184815260200183600160a060020a0316600160a060020a03168152602001828051906020019080838360008314610927575b80518252602083111561092757601f199092019160209182019101610907565b505050905090810190601f1680156109535780820380516001836020036101000a031916815260200191505b509450505050506000604051808303816000876161da5a03f192505050151561097b57610000565b5060015b9392505050565b600160a060020a038083166000908152600160209081526040808320938516835292905220545b929150505600a165627a7a72305820168b9df5f418bacd17a463aee57d9d1942ea7f90ba20e1d952410fe0bb65353e0029",
                "contractAddress": "0xadad45e84dc04b64a69817f3856862297048fb73",
                "cumulativeGasUsed": "1544173",
                "gasUsed": "889001",
                "confirmations": "15036302",
                "methodId": "0x60a06040",
                "functionName": ""
            },
            {
                "blockNumber": "4260051",
                "timeStamp": "1505077203",
                "hash": "0xc918fae6621c67450562c3d70f44b5f0ba676b5c02361eaf858ba9533d06edcd",
                "nonce": "5",
                "blockHash": "0x4d313ae529d619072132116b5aefb396d5c6a5a61c85598cac40545de969428a",
                "transactionIndex": "13",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "",
                "value": "0",
                "gas": "889922",
                "gasPrice": "22000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x60a0604052600460608190527f48312e300000000000000000000000000000000000000000000000000000000060809081526006805460008290527f48312e3000000000000000000000000000000000000000000000000000000008825590927ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f602060026001851615610100026000190190941693909304601f01929092048201929091906100d7565b828001600101855582156100d7579182015b828111156100d75782518255916020019190600101906100bc565b5b506100f89291505b808211156100f457600081556001016100e0565b5090565b505034610000575b33600160a060020a031660009081526020818152604080832063b2d05e009081905560029081558151808301909252600b8083527f53696e67756c617269747900000000000000000000000000000000000000000092840192835260038054958190528351601660ff19909116178155947fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b6001821615610100026000190190911692909204601f0193909304810192916101e3565b828001600101855582156101e3579182015b828111156101e35782518255916020019190600101906101c8565b5b506102049291505b808211156100f457600081556001016100e0565b5090565b505060048054600260ff1991821681178355604080518082019091528181527f41490000000000000000000000000000000000000000000000000000000000006020918201908152600580546000829052825190951690951785557f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db061010060018616150260001901909416839004601f0191909104830192906102d0565b828001600101855582156102d0579182015b828111156102d05782518255916020019190600101906102b5565b5b506102f19291505b808211156100f457600081556001016100e0565b5090565b50505b5b6109df806103046000396000f300606060405236156100935763ffffffff60e060020a60003504166306fdde0381146100a5578063095ea7b31461013257806318160ddd1461016257806323b872dd14610181578063313ce567146101b757806354fd4d50146101da57806370a082311461026757806395d89b4114610292578063a9059cbb1461031f578063cae9ca511461034f578063dd62ed3e146103c3575b34610000576100a35b610000565b565b005b34610000576100b26103f4565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a0360043516602435610482565b604080519115158252519081900360200190f35b346100005761016f6104ed565b60408051918252519081900360200190f35b346100005761014e600160a060020a03600435811690602435166044356104f3565b604080519115158252519081900360200190f35b34610000576101c46105e7565b6040805160ff9092168252519081900360200190f35b34610000576100b26105f0565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761016f600160a060020a036004351661067e565b60408051918252519081900360200190f35b34610000576100b261069d565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a036004351660243561072b565b604080519115158252519081900360200190f35b3461000057604080516020600460443581810135601f810184900484028501840190955284845261014e948235600160a060020a03169460248035956064949293919092019181908401838280828437509496506107d595505050505050565b604080519115158252519081900360200190f35b346100005761016f600160a060020a0360043581169060243516610986565b60408051918252519081900360200190f35b6003805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a03338116600081815260016020908152604080832094871680845294825280832086905580518681529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a35060015b92915050565b60025481565b600160a060020a0383166000908152602081905260408120548290108015906105435750600160a060020a0380851660009081526001602090815260408083203390941683529290522054829010155b801561054f5750600082115b156105db57600160a060020a0380841660008181526020818152604080832080548801905588851680845281842080548990039055600183528184203390961684529482529182902080548790039055815186815291519293927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9281900390910190a35060016105df565b5060005b5b9392505050565b60045460ff1681565b6006805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0381166000908152602081905260409020545b919050565b6005805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0333166000908152602081905260408120548290108015906107545750600082115b156107c657600160a060020a0333811660008181526020818152604080832080548890039055938716808352918490208054870190558351868152935191937fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef929081900390910190a35060016104e7565b5060006104e7565b5b92915050565b600160a060020a03338116600081815260016020908152604080832094881680845294825280832087905580518781529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a383600160a060020a031660405180807f72656365697665417070726f76616c28616464726573732c75696e743235362c81526020017f616464726573732c627974657329000000000000000000000000000000000000815250602e019050604051809103902060e060020a9004338530866040518563ffffffff1660e060020a0281526004018085600160a060020a0316600160a060020a0316815260200184815260200183600160a060020a0316600160a060020a03168152602001828051906020019080838360008314610927575b80518252602083111561092757601f199092019160209182019101610907565b505050905090810190601f1680156109535780820380516001836020036101000a031916815260200191505b509450505050506000604051808303816000876161da5a03f192505050151561097b57610000565b5060015b9392505050565b600160a060020a038083166000908152600160209081526040808320938516835292905220545b929150505600a165627a7a7230582047c4aa44eddca7cecdf8d17249f73ca7b249b81b2f8d15ac138b4d8be17b16e80029",
                "contractAddress": "0x660db3ed99edb058ce0f6aaece248c430afb4569",
                "cumulativeGasUsed": "1350590",
                "gasUsed": "889921",
                "confirmations": "15036270",
                "methodId": "0x60a06040",
                "functionName": ""
            },
            {
                "blockNumber": "4260071",
                "timeStamp": "1505077574",
                "hash": "0xe78d7f48607fecb60d2f34df3413c0e1eb984e872b82f86567001a4e5c1ea8b0",
                "nonce": "6",
                "blockHash": "0x82c1c7c6c94650dcf4f860881426e22e71b1daa9954106dc4b3320d7275a7b91",
                "transactionIndex": "29",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "0x660db3ed99edb058ce0f6aaece248c430afb4569",
                "value": "0",
                "gas": "151395",
                "gasPrice": "22000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0xa9059cbb000000000000000000000000663a25c59059df9143ba5f8084152f83e433528e000000000000000000000000000000000000000000000000000000001dcd6500",
                "contractAddress": "",
                "cumulativeGasUsed": "1867453",
                "gasUsed": "51394",
                "confirmations": "15036250",
                "methodId": "0xa9059cbb",
                "functionName": "transfer(address _to, uint256 _value)"
            },
            {
                "blockNumber": "4260092",
                "timeStamp": "1505078198",
                "hash": "0x79b19b67924e0c9e631a62193484fd3bb92e02869a65ed992f199765b1fc8d3d",
                "nonce": "7",
                "blockHash": "0xdad74309967f3801bc836d40952947fc188148dc6f8e8983724aa1d4b6f591f0",
                "transactionIndex": "18",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "",
                "value": "0",
                "gas": "899684",
                "gasPrice": "22000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x60a0604052600460608190527f48312e300000000000000000000000000000000000000000000000000000000060809081526006805460008290527f48312e3000000000000000000000000000000000000000000000000000000008825590927ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f602060026001851615610100026000190190941693909304601f01929092048201929091906100d7565b828001600101855582156100d7579182015b828111156100d75782518255916020019190600101906100bc565b5b506100f89291505b808211156100f457600081556001016100e0565b5090565b505034610000575b33600160a060020a031660009081526020818152604080832063b2d05e00908190556002908155815180830190925260038083527f44616900000000000000000000000000000000000000000000000000000000009284019283528054948190528251600660ff19909116178155937fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b6001821615610100026000190190911691909104601f019290920482019183916101e2565b828001600101855582156101e2579182015b828111156101e25782518255916020019190600101906101c7565b5b506102039291505b808211156100f457600081556001016100e0565b5090565b50506004805460ff191660029081179091556040805180820190915260038082527f444149000000000000000000000000000000000000000000000000000000000060209283019081526005805460008290529094601f600019600184161561010002019092160401929092047f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db090810192805160ff19168380011785556102d3565b828001600101855582156102d3579182015b828111156102d35782518255916020019190600101906102b8565b5b506102f49291505b808211156100f457600081556001016100e0565b5090565b50505b5b6109df806103076000396000f300606060405236156100935763ffffffff60e060020a60003504166306fdde0381146100a5578063095ea7b31461013257806318160ddd1461016257806323b872dd14610181578063313ce567146101b757806354fd4d50146101da57806370a082311461026757806395d89b4114610292578063a9059cbb1461031f578063cae9ca511461034f578063dd62ed3e146103c3575b34610000576100a35b610000565b565b005b34610000576100b26103f4565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a0360043516602435610482565b604080519115158252519081900360200190f35b346100005761016f6104ed565b60408051918252519081900360200190f35b346100005761014e600160a060020a03600435811690602435166044356104f3565b604080519115158252519081900360200190f35b34610000576101c46105e7565b6040805160ff9092168252519081900360200190f35b34610000576100b26105f0565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761016f600160a060020a036004351661067e565b60408051918252519081900360200190f35b34610000576100b261069d565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a036004351660243561072b565b604080519115158252519081900360200190f35b3461000057604080516020600460443581810135601f810184900484028501840190955284845261014e948235600160a060020a03169460248035956064949293919092019181908401838280828437509496506107d595505050505050565b604080519115158252519081900360200190f35b346100005761016f600160a060020a0360043581169060243516610986565b60408051918252519081900360200190f35b6003805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a03338116600081815260016020908152604080832094871680845294825280832086905580518681529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a35060015b92915050565b60025481565b600160a060020a0383166000908152602081905260408120548290108015906105435750600160a060020a0380851660009081526001602090815260408083203390941683529290522054829010155b801561054f5750600082115b156105db57600160a060020a0380841660008181526020818152604080832080548801905588851680845281842080548990039055600183528184203390961684529482529182902080548790039055815186815291519293927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9281900390910190a35060016105df565b5060005b5b9392505050565b60045460ff1681565b6006805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0381166000908152602081905260409020545b919050565b6005805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0333166000908152602081905260408120548290108015906107545750600082115b156107c657600160a060020a0333811660008181526020818152604080832080548890039055938716808352918490208054870190558351868152935191937fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef929081900390910190a35060016104e7565b5060006104e7565b5b92915050565b600160a060020a03338116600081815260016020908152604080832094881680845294825280832087905580518781529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a383600160a060020a031660405180807f72656365697665417070726f76616c28616464726573732c75696e743235362c81526020017f616464726573732c627974657329000000000000000000000000000000000000815250602e019050604051809103902060e060020a9004338530866040518563ffffffff1660e060020a0281526004018085600160a060020a0316600160a060020a0316815260200184815260200183600160a060020a0316600160a060020a03168152602001828051906020019080838360008314610927575b80518252602083111561092757601f199092019160209182019101610907565b505050905090810190601f1680156109535780820380516001836020036101000a031916815260200191505b509450505050506000604051808303816000876161da5a03f192505050151561097b57610000565b5060015b9392505050565b600160a060020a038083166000908152600160209081526040808320938516835292905220545b929150505600a165627a7a7230582031edb43f3bd896ec38c1373e442bc11dbf7fa311c4203cd72dd39d67f64c25ed0029",
                "contractAddress": "0xc94a6e7776bade5da316cf6fd8c751fb0d5c3c5e",
                "cumulativeGasUsed": "1480412",
                "gasUsed": "889683",
                "confirmations": "15036229",
                "methodId": "0x60a06040",
                "functionName": ""
            },
            {
                "blockNumber": "4260142",
                "timeStamp": "1505079443",
                "hash": "0x1431bff0bbfb811cb269009c67b557a5d6cfc8508f425d6e997ecd93b8c7af6e",
                "nonce": "8",
                "blockHash": "0xf975ef975e5cdde50ad3a3ba7aa7b08adf4b173746bdd8efbe367a2fd5d67eb0",
                "transactionIndex": "123",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "0xf9b0a119574190d2e2796662ff05e79300a0fcca",
                "value": "0",
                "gas": "51623",
                "gasPrice": "21000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0xa9059cbb000000000000000000000000663a25c59059df9143ba5f8084152f83e433528e0000000000000000000000000000000000000000000000000000000000989680",
                "contractAddress": "",
                "cumulativeGasUsed": "4838989",
                "gasUsed": "36623",
                "confirmations": "15036179",
                "methodId": "0xa9059cbb",
                "functionName": "transfer(address _to, uint256 _value)"
            }
        ]
    }
    
    const result = response.result;
    const { nodes, edges } = extractInfo(result);
    const allLoops = detectAllLoops(nodes, edges);

    if (allLoops.length > 0) {
      console.log("Loops detected:", allLoops);
    } else {
      console.log("No loops detected");
    }
    res.status(200).json({ loops: allLoops });
  } catch (error) {
    console.error("Error detecting anomaly:", error);
    next(error);
  }
});

function extractInfo(result) {
  const nodes = new Set();
  const edges = [];
  console.log(result);

  result.forEach((obj) => {
    nodes.add(obj.from);
    nodes.add(obj.to);
    edges.push([obj.from, obj.to, obj.hash]);
  });

  return { nodes, edges };
}
function detectAllLoops(nodes, edges) {
  const graph = {};
  const edgeMap = {}; // Map to store edges based on from-to combination

  // Initialize the graph with empty arrays for each node
  nodes.forEach((node) => {
    graph[node] = [];
  });

  // Construct the graph
  edges.forEach((edge) => {
    const [from, to, hash] = edge;
    graph[from].push(to);
    // Store the edge in the edge map
    edgeMap[`${from}-${to}`] = { to, hash };
  });

  const visited = new Set();
  const allLoops = [];

  function dfs(node, stack, parent) {
    visited.add(node);
    stack.push(node);

    for (const neighbor of graph[node]) {
      if (!visited.has(neighbor)) {
        dfs(neighbor, stack, node);
      } else if (stack.includes(neighbor)) {
        // Construct the loop with edge information
        let cycle = [];
        let index = stack.indexOf(neighbor);
        for (let i = index; i < stack.length; i++) {
          const from = stack[i];
          const to = stack[i + 1] || stack[0]; // Wrap around for the last node
          cycle.push(edgeMap[`${from}-${to}`]); // Get edge information from the edge map
        }
        allLoops.push(cycle);
      }
    }

    stack.pop();
  }

  // Perform DFS for each node
  for (const node of nodes) {
    const stack = [];
    dfs(node, stack, null);
  }

  return allLoops;
}

function detectLoop(nodes, edges) {
  const graph = {};
  nodes.forEach((node) => (graph[node] = []));

  edges.forEach((edge) => {
    graph[edge[0]].push(edge[1]);
  });

  const visited = new Set();
  const stack = new Set();
  const parent = {};

  function dfs(node) {
    visited.add(node);
    stack.add(node);

    for (const neighbor of graph[node]) {
      if (!visited.has(neighbor)) {
        parent[neighbor] = node;
        const cycle = dfs(neighbor);
        if (cycle) return cycle;
      } else if (stack.has(neighbor)) {
        let cycleStart = neighbor;
        let cycleEnd = node;
        const cycle = [cycleEnd];
        while (cycleEnd !== cycleStart) {
          cycleEnd = parent[cycleEnd];
          cycle.push(cycleEnd);
        }
        return cycle;
      }
    }

    stack.delete(node);
    return null;
  }

  for (const node of nodes) {
    if (!visited.has(node)) {
      const cycle = dfs(node);
      if (cycle) return cycle;
    }
  }

  return null;
}

// Define the function to get transactions within a 1-day time frame

// Define the function to get transactions within a 1-day time frame and aggregate their values
exports.filterTransactions = async (req, res, next) => {
  try {
    const { from, to, threshold } = req.body;
    const currentTime = Math.floor(Date.now() / 1000); // Get current time in seconds
    const oneDayInSeconds = 24 * 60 * 60; // Number of seconds in a day
    const numberOfDays = 5000; // Number of days to calculate

    // const response = await axios.get(url);
    const response={
        "status": "1",
        "message": "OK",
        "result": [
            {
                "blockNumber": "4259813",
                "timeStamp": "1708689943",
                "hash": "0x607eaeeb27afe0e5bacaf020488476844ab9abcfaceafaf2cff458510de23a04",
                "nonce": "464",
                "blockHash": "0x0050d9ad58a59c894a18cf47e28e81b9ea980d2c7d46f8552f00ae3a6d5c14fc",
                "transactionIndex": "31",
                "from": "0x98c5c9dc6dd44d6dc07cbac11df9e0f38594cf42",
                "to": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "value": "91841178427085834",
                "gas": "21000",
                "gasPrice": "21834513098",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x",
                "contractAddress": "",
                "cumulativeGasUsed": "1237380",
                "gasUsed": "21000",
                "confirmations": "15036508",
                "methodId": "0x",
                "functionName": ""
            },
            {
                "blockNumber": "4259822",
                "timeStamp": "1708689944",
                "hash": "0x2df037ae6da450e371ac56ec715598ee7275e491f94adb493be913f47638cab1",
                "nonce": "0",
                "blockHash": "0xf1d043750a2950ec270bee3f0f79c89d92d652576b1dfb92f00af2b63de2056a",
                "transactionIndex": "26",
                "from": "0x98c5c9dc6dd44d6dc07cbac11df9e0f38594cf42",
                "to": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "value": "1000000000000000",
                "gas": "250000",
                "gasPrice": "4000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x095ea7b30000000000000000000000008d12a197cb00d4747a1fe03395095ce2a5cc681900000000000000000000000000000000000000000000000000000000000002f7",
                "contractAddress": "",
                "cumulativeGasUsed": "1221371",
                "gasUsed": "45206",
                "confirmations": "15036499",
                "methodId": "0x095ea7b3",
                "functionName": "approve(address _spender, uint256 _value)"
            },
            {
                "blockNumber": "4259822",
                "timeStamp": "1708689945",
                "hash": "0xa9e0d6907374a8ca0075cec56c694cc61cbd4c5b49fa12fc30a306c23f34616e",
                "nonce": "1",
                "blockHash": "0xf1d043750a2950ec270bee3f0f79c89d92d652576b1dfb92f00af2b63de2056a",
                "transactionIndex": "30",
                "from": "0x98c5c9dc6dd44d6dc07cbac11df9e0f38594cf42",
                "to": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "value": "10000000000000000",
                "gas": "250000",
                "gasPrice": "4000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x338b5dea00000000000000000000000084119cb33e8f590d75c2d6ea4e6b0741a7494eda00000000000000000000000000000000000000000000000000000000000002f7",
                "contractAddress": "",
                "cumulativeGasUsed": "1587746",
                "gasUsed": "38357",
                "confirmations": "15036499",
                "methodId": "0x338b5dea",
                "functionName": "depositToken(address token, uint256 amount)"
            },
            {
                "blockNumber": "4259896",
                "timeStamp": "1708689946",
                "hash": "0xab4d20d814db983d374f383cfb452b6ffe092943544f5798a6da8ded47549f0b",
                "nonce": "2",
                "blockHash": "0x55dcc90978a586d8486655784f54f375c0d180248d1dd7629887e6eb644a5189",
                "transactionIndex": "81",
                "from": "0x98c5c9dc6dd44d6dc07cbac11df9e0f38594cf42",
                "to": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "value": "10000000000000000",
                "gas": "603116",
                "gasPrice": "22000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x60a0604052600960608190527f546f6b656e20302e3100000000000000000000000000000000000000000000006080908152600080548180527f546f6b656e20302e310000000000000000000000000000000000000000000012825590927f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563602060026001851615610100026000190190941693909304601f01929092048201929091906100d5565b828001600101855582156100d5579182015b828111156100d55782518255916020019190600101906100ba565b5b506100f69291505b808211156100f257600081556001016100de565b5090565b50503461000057604051610868380380610868833981016040908152815160208301519183015160608401519193928301929091015b33600160a060020a031660009081526005602090815260408220869055600486905584516001805493819052927fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6600282861615610100026000190190921691909104601f9081018490048201938801908390106101b557805160ff19168380011785556101e2565b828001600101855582156101e2579182015b828111156101e25782518255916020019190600101906101c7565b5b506102039291505b808211156100f257600081556001016100de565b5090565b50508060029080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061025157805160ff191683800117855561027e565b8280016001018555821561027e579182015b8281111561027e578251825591602001919060010190610263565b5b5061029f9291505b808211156100f257600081556001016100de565b5090565b50506003805460ff191660ff84161790555b505050505b6105a3806102c56000396000f300606060405236156100725763ffffffff60e060020a60003504166306fdde03811461007757806318160ddd14610104578063313ce567146101235780635a3b7e421461014657806370a08231146101d357806395d89b41146101fe578063a9059cbb1461028b578063dd62ed3e146102a9575b610000565b34610000576100846102da565b6040805160208082528351818301528351919283929083019185019080838382156100ca575b8051825260208311156100ca57601f1990920191602091820191016100aa565b505050905090810190601f1680156100f65780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3461000057610111610367565b60408051918252519081900360200190f35b346100005761013061036d565b6040805160ff9092168252519081900360200190f35b3461000057610084610376565b6040805160208082528351818301528351919283929083019185019080838382156100ca575b8051825260208311156100ca57601f1990920191602091820191016100aa565b505050905090810190601f1680156100f65780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3461000057610111600160a060020a0360043516610404565b60408051918252519081900360200190f35b3461000057610084610416565b6040805160208082528351818301528351919283929083019185019080838382156100ca575b8051825260208311156100ca57601f1990920191602091820191016100aa565b505050905090810190601f1680156100f65780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34610000576102a7600160a060020a03600435166024356104a1565b005b3461000057610111600160a060020a036004358116906024351661055a565b60408051918252519081900360200190f35b60018054604080516020600284861615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561035f5780601f106103345761010080835404028352916020019161035f565b820191906000526020600020905b81548152906001019060200180831161034257829003601f168201915b505050505081565b60045481565b60035460ff1681565b6000805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561035f5780601f106103345761010080835404028352916020019161035f565b820191906000526020600020905b81548152906001019060200180831161034257829003601f168201915b505050505081565b60056020526000908152604090205481565b6002805460408051602060018416156101000260001901909316849004601f8101849004840282018401909252818152929183018282801561035f5780601f106103345761010080835404028352916020019161035f565b820191906000526020600020905b81548152906001019060200180831161034257829003601f168201915b505050505081565b600160a060020a033316600090815260056020526040902054819010156104c757610000565b600160a060020a03821660009081526005602052604090205481810110156104ee57610000565b600160a060020a03338116600081815260056020908152604080832080548790039055938616808352918490208054860190558351858152935191937fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef929081900390910190a35b5050565b6006602090815260009283526040808420909152908252902054815600a165627a7a72305820220ca6f7af6bb8f1b75088455607edb3182b12a2d6293d2640ebfeffbca9d156002900000000000000000000000000000000000000000000000000000000009896800000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000003465544000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000034655440000000000000000000000000000000000000000000000000000000000",
                "contractAddress": "0xf9b0a119574190d2e2796662ff05e79300a0fcca",
                "cumulativeGasUsed": "3594865",
                "gasUsed": "603115",
                "confirmations": "15036425",
                "methodId": "0x60a06040",
                "functionName": ""
            },
            {
                "blockNumber": "4259931",
                "timeStamp": "1505074244",
                "hash": "0xa3bfeeef8bae97ab5901d832b5d35b5cb0d0ae23e25f53b6fc9d08d9fc29731b",
                "nonce": "3",
                "blockHash": "0x7eac1b9d827ae54e60a90a08d9a5ddaf2099d5970bcfb9dabca7c8e09d24ed8b",
                "transactionIndex": "17",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "0x663a25c59059df9143ba5f8084152f83e433528e",
                "value": "10000000000000000",
                "gas": "121001",
                "gasPrice": "22000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x",
                "contractAddress": "",
                "cumulativeGasUsed": "476962",
                "gasUsed": "21000",
                "confirmations": "15036390",
                "methodId": "0x",
                "functionName": ""
            },
            {
                "blockNumber": "4260019",
                "timeStamp": "1505076578",
                "hash": "0x4d664fc7fe0bb7c45534a91080727e019fc1081ca73d0c7911aeb2ab45aff1ad",
                "nonce": "4",
                "blockHash": "0x95b358400c27b3599b604a7db7f65b8e1a3eca4facc597f78b48af0fe1a16e3f",
                "transactionIndex": "20",
                "from": "0x663a25c59059df9143ba5f8084152f83e433528e",
                "to": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "value": "0",
                "gas": "889001",
                "gasPrice": "21000000000",
                "isError": "1",
                "txreceipt_status": "",
                "input": "0x60a0604052600460608190527f48312e300000000000000000000000000000000000000000000000000000000060809081526006805460008290527f48312e3000000000000000000000000000000000000000000000000000000008825590927ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f602060026001851615610100026000190190941693909304601f01929092048201929091906100d7565b828001600101855582156100d7579182015b828111156100d75782518255916020019190600101906100bc565b5b506100f89291505b808211156100f457600081556001016100e0565b5090565b505034610000575b33600160a060020a031660009081526020818152604080832063b2d05e00908190556002908155815180830190925260038083527f4c4f4c00000000000000000000000000000000000000000000000000000000009284019283528054948190528251600660ff19909116178155937fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b6001821615610100026000190190911691909104601f019290920482019183916101e2565b828001600101855582156101e2579182015b828111156101e25782518255916020019190600101906101c7565b5b506102039291505b808211156100f457600081556001016100e0565b5090565b50506004805460ff191660029081179091556040805180820190915260038082527f4c4f4c000000000000000000000000000000000000000000000000000000000060209283019081526005805460008290529094601f600019600184161561010002019092160401929092047f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db090810192805160ff19168380011785556102d3565b828001600101855582156102d3579182015b828111156102d35782518255916020019190600101906102b8565b5b506102f49291505b808211156100f457600081556001016100e0565b5090565b50505b5b6109df806103076000396000f300606060405236156100935763ffffffff60e060020a60003504166306fdde0381146100a5578063095ea7b31461013257806318160ddd1461016257806323b872dd14610181578063313ce567146101b757806354fd4d50146101da57806370a082311461026757806395d89b4114610292578063a9059cbb1461031f578063cae9ca511461034f578063dd62ed3e146103c3575b34610000576100a35b610000565b565b005b34610000576100b26103f4565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a0360043516602435610482565b604080519115158252519081900360200190f35b346100005761016f6104ed565b60408051918252519081900360200190f35b346100005761014e600160a060020a03600435811690602435166044356104f3565b604080519115158252519081900360200190f35b34610000576101c46105e7565b6040805160ff9092168252519081900360200190f35b34610000576100b26105f0565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761016f600160a060020a036004351661067e565b60408051918252519081900360200190f35b34610000576100b261069d565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a036004351660243561072b565b604080519115158252519081900360200190f35b3461000057604080516020600460443581810135601f810184900484028501840190955284845261014e948235600160a060020a03169460248035956064949293919092019181908401838280828437509496506107d595505050505050565b604080519115158252519081900360200190f35b346100005761016f600160a060020a0360043581169060243516610986565b60408051918252519081900360200190f35b6003805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a03338116600081815260016020908152604080832094871680845294825280832086905580518681529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a35060015b92915050565b60025481565b600160a060020a0383166000908152602081905260408120548290108015906105435750600160a060020a0380851660009081526001602090815260408083203390941683529290522054829010155b801561054f5750600082115b156105db57600160a060020a0380841660008181526020818152604080832080548801905588851680845281842080548990039055600183528184203390961684529482529182902080548790039055815186815291519293927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9281900390910190a35060016105df565b5060005b5b9392505050565b60045460ff1681565b6006805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0381166000908152602081905260409020545b919050565b6005805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0333166000908152602081905260408120548290108015906107545750600082115b156107c657600160a060020a0333811660008181526020818152604080832080548890039055938716808352918490208054870190558351868152935191937fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef929081900390910190a35060016104e7565b5060006104e7565b5b92915050565b600160a060020a03338116600081815260016020908152604080832094881680845294825280832087905580518781529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a383600160a060020a031660405180807f72656365697665417070726f76616c28616464726573732c75696e743235362c81526020017f616464726573732c627974657329000000000000000000000000000000000000815250602e019050604051809103902060e060020a9004338530866040518563ffffffff1660e060020a0281526004018085600160a060020a0316600160a060020a0316815260200184815260200183600160a060020a0316600160a060020a03168152602001828051906020019080838360008314610927575b80518252602083111561092757601f199092019160209182019101610907565b505050905090810190601f1680156109535780820380516001836020036101000a031916815260200191505b509450505050506000604051808303816000876161da5a03f192505050151561097b57610000565b5060015b9392505050565b600160a060020a038083166000908152600160209081526040808320938516835292905220545b929150505600a165627a7a72305820168b9df5f418bacd17a463aee57d9d1942ea7f90ba20e1d952410fe0bb65353e0029",
                "contractAddress": "0xadad45e84dc04b64a69817f3856862297048fb73",
                "cumulativeGasUsed": "1544173",
                "gasUsed": "889001",
                "confirmations": "15036302",
                "methodId": "0x60a06040",
                "functionName": ""
            },
            {
                "blockNumber": "4260051",
                "timeStamp": "1505077203",
                "hash": "0xc918fae6621c67450562c3d70f44b5f0ba676b5c02361eaf858ba9533d06edcd",
                "nonce": "5",
                "blockHash": "0x4d313ae529d619072132116b5aefb396d5c6a5a61c85598cac40545de969428a",
                "transactionIndex": "13",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "",
                "value": "0",
                "gas": "889922",
                "gasPrice": "22000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x60a0604052600460608190527f48312e300000000000000000000000000000000000000000000000000000000060809081526006805460008290527f48312e3000000000000000000000000000000000000000000000000000000008825590927ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f602060026001851615610100026000190190941693909304601f01929092048201929091906100d7565b828001600101855582156100d7579182015b828111156100d75782518255916020019190600101906100bc565b5b506100f89291505b808211156100f457600081556001016100e0565b5090565b505034610000575b33600160a060020a031660009081526020818152604080832063b2d05e009081905560029081558151808301909252600b8083527f53696e67756c617269747900000000000000000000000000000000000000000092840192835260038054958190528351601660ff19909116178155947fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b6001821615610100026000190190911692909204601f0193909304810192916101e3565b828001600101855582156101e3579182015b828111156101e35782518255916020019190600101906101c8565b5b506102049291505b808211156100f457600081556001016100e0565b5090565b505060048054600260ff1991821681178355604080518082019091528181527f41490000000000000000000000000000000000000000000000000000000000006020918201908152600580546000829052825190951690951785557f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db061010060018616150260001901909416839004601f0191909104830192906102d0565b828001600101855582156102d0579182015b828111156102d05782518255916020019190600101906102b5565b5b506102f19291505b808211156100f457600081556001016100e0565b5090565b50505b5b6109df806103046000396000f300606060405236156100935763ffffffff60e060020a60003504166306fdde0381146100a5578063095ea7b31461013257806318160ddd1461016257806323b872dd14610181578063313ce567146101b757806354fd4d50146101da57806370a082311461026757806395d89b4114610292578063a9059cbb1461031f578063cae9ca511461034f578063dd62ed3e146103c3575b34610000576100a35b610000565b565b005b34610000576100b26103f4565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a0360043516602435610482565b604080519115158252519081900360200190f35b346100005761016f6104ed565b60408051918252519081900360200190f35b346100005761014e600160a060020a03600435811690602435166044356104f3565b604080519115158252519081900360200190f35b34610000576101c46105e7565b6040805160ff9092168252519081900360200190f35b34610000576100b26105f0565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761016f600160a060020a036004351661067e565b60408051918252519081900360200190f35b34610000576100b261069d565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a036004351660243561072b565b604080519115158252519081900360200190f35b3461000057604080516020600460443581810135601f810184900484028501840190955284845261014e948235600160a060020a03169460248035956064949293919092019181908401838280828437509496506107d595505050505050565b604080519115158252519081900360200190f35b346100005761016f600160a060020a0360043581169060243516610986565b60408051918252519081900360200190f35b6003805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a03338116600081815260016020908152604080832094871680845294825280832086905580518681529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a35060015b92915050565b60025481565b600160a060020a0383166000908152602081905260408120548290108015906105435750600160a060020a0380851660009081526001602090815260408083203390941683529290522054829010155b801561054f5750600082115b156105db57600160a060020a0380841660008181526020818152604080832080548801905588851680845281842080548990039055600183528184203390961684529482529182902080548790039055815186815291519293927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9281900390910190a35060016105df565b5060005b5b9392505050565b60045460ff1681565b6006805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0381166000908152602081905260409020545b919050565b6005805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0333166000908152602081905260408120548290108015906107545750600082115b156107c657600160a060020a0333811660008181526020818152604080832080548890039055938716808352918490208054870190558351868152935191937fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef929081900390910190a35060016104e7565b5060006104e7565b5b92915050565b600160a060020a03338116600081815260016020908152604080832094881680845294825280832087905580518781529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a383600160a060020a031660405180807f72656365697665417070726f76616c28616464726573732c75696e743235362c81526020017f616464726573732c627974657329000000000000000000000000000000000000815250602e019050604051809103902060e060020a9004338530866040518563ffffffff1660e060020a0281526004018085600160a060020a0316600160a060020a0316815260200184815260200183600160a060020a0316600160a060020a03168152602001828051906020019080838360008314610927575b80518252602083111561092757601f199092019160209182019101610907565b505050905090810190601f1680156109535780820380516001836020036101000a031916815260200191505b509450505050506000604051808303816000876161da5a03f192505050151561097b57610000565b5060015b9392505050565b600160a060020a038083166000908152600160209081526040808320938516835292905220545b929150505600a165627a7a7230582047c4aa44eddca7cecdf8d17249f73ca7b249b81b2f8d15ac138b4d8be17b16e80029",
                "contractAddress": "0x660db3ed99edb058ce0f6aaece248c430afb4569",
                "cumulativeGasUsed": "1350590",
                "gasUsed": "889921",
                "confirmations": "15036270",
                "methodId": "0x60a06040",
                "functionName": ""
            },
            {
                "blockNumber": "4260071",
                "timeStamp": "1505077574",
                "hash": "0xe78d7f48607fecb60d2f34df3413c0e1eb984e872b82f86567001a4e5c1ea8b0",
                "nonce": "6",
                "blockHash": "0x82c1c7c6c94650dcf4f860881426e22e71b1daa9954106dc4b3320d7275a7b91",
                "transactionIndex": "29",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "0x660db3ed99edb058ce0f6aaece248c430afb4569",
                "value": "0",
                "gas": "151395",
                "gasPrice": "22000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0xa9059cbb000000000000000000000000663a25c59059df9143ba5f8084152f83e433528e000000000000000000000000000000000000000000000000000000001dcd6500",
                "contractAddress": "",
                "cumulativeGasUsed": "1867453",
                "gasUsed": "51394",
                "confirmations": "15036250",
                "methodId": "0xa9059cbb",
                "functionName": "transfer(address _to, uint256 _value)"
            },
            {
                "blockNumber": "4260092",
                "timeStamp": "1505078198",
                "hash": "0x79b19b67924e0c9e631a62193484fd3bb92e02869a65ed992f199765b1fc8d3d",
                "nonce": "7",
                "blockHash": "0xdad74309967f3801bc836d40952947fc188148dc6f8e8983724aa1d4b6f591f0",
                "transactionIndex": "18",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "",
                "value": "0",
                "gas": "899684",
                "gasPrice": "22000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0x60a0604052600460608190527f48312e300000000000000000000000000000000000000000000000000000000060809081526006805460008290527f48312e3000000000000000000000000000000000000000000000000000000008825590927ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f602060026001851615610100026000190190941693909304601f01929092048201929091906100d7565b828001600101855582156100d7579182015b828111156100d75782518255916020019190600101906100bc565b5b506100f89291505b808211156100f457600081556001016100e0565b5090565b505034610000575b33600160a060020a031660009081526020818152604080832063b2d05e00908190556002908155815180830190925260038083527f44616900000000000000000000000000000000000000000000000000000000009284019283528054948190528251600660ff19909116178155937fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b6001821615610100026000190190911691909104601f019290920482019183916101e2565b828001600101855582156101e2579182015b828111156101e25782518255916020019190600101906101c7565b5b506102039291505b808211156100f457600081556001016100e0565b5090565b50506004805460ff191660029081179091556040805180820190915260038082527f444149000000000000000000000000000000000000000000000000000000000060209283019081526005805460008290529094601f600019600184161561010002019092160401929092047f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db090810192805160ff19168380011785556102d3565b828001600101855582156102d3579182015b828111156102d35782518255916020019190600101906102b8565b5b506102f49291505b808211156100f457600081556001016100e0565b5090565b50505b5b6109df806103076000396000f300606060405236156100935763ffffffff60e060020a60003504166306fdde0381146100a5578063095ea7b31461013257806318160ddd1461016257806323b872dd14610181578063313ce567146101b757806354fd4d50146101da57806370a082311461026757806395d89b4114610292578063a9059cbb1461031f578063cae9ca511461034f578063dd62ed3e146103c3575b34610000576100a35b610000565b565b005b34610000576100b26103f4565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a0360043516602435610482565b604080519115158252519081900360200190f35b346100005761016f6104ed565b60408051918252519081900360200190f35b346100005761014e600160a060020a03600435811690602435166044356104f3565b604080519115158252519081900360200190f35b34610000576101c46105e7565b6040805160ff9092168252519081900360200190f35b34610000576100b26105f0565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761016f600160a060020a036004351661067e565b60408051918252519081900360200190f35b34610000576100b261069d565b6040805160208082528351818301528351919283929083019185019080838382156100f8575b8051825260208311156100f857601f1990920191602091820191016100d8565b505050905090810190601f1680156101245780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761014e600160a060020a036004351660243561072b565b604080519115158252519081900360200190f35b3461000057604080516020600460443581810135601f810184900484028501840190955284845261014e948235600160a060020a03169460248035956064949293919092019181908401838280828437509496506107d595505050505050565b604080519115158252519081900360200190f35b346100005761016f600160a060020a0360043581169060243516610986565b60408051918252519081900360200190f35b6003805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a03338116600081815260016020908152604080832094871680845294825280832086905580518681529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a35060015b92915050565b60025481565b600160a060020a0383166000908152602081905260408120548290108015906105435750600160a060020a0380851660009081526001602090815260408083203390941683529290522054829010155b801561054f5750600082115b156105db57600160a060020a0380841660008181526020818152604080832080548801905588851680845281842080548990039055600183528184203390961684529482529182902080548790039055815186815291519293927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9281900390910190a35060016105df565b5060005b5b9392505050565b60045460ff1681565b6006805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0381166000908152602081905260409020545b919050565b6005805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561047a5780601f1061044f5761010080835404028352916020019161047a565b820191906000526020600020905b81548152906001019060200180831161045d57829003601f168201915b505050505081565b600160a060020a0333166000908152602081905260408120548290108015906107545750600082115b156107c657600160a060020a0333811660008181526020818152604080832080548890039055938716808352918490208054870190558351868152935191937fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef929081900390910190a35060016104e7565b5060006104e7565b5b92915050565b600160a060020a03338116600081815260016020908152604080832094881680845294825280832087905580518781529051929493927f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925929181900390910190a383600160a060020a031660405180807f72656365697665417070726f76616c28616464726573732c75696e743235362c81526020017f616464726573732c627974657329000000000000000000000000000000000000815250602e019050604051809103902060e060020a9004338530866040518563ffffffff1660e060020a0281526004018085600160a060020a0316600160a060020a0316815260200184815260200183600160a060020a0316600160a060020a03168152602001828051906020019080838360008314610927575b80518252602083111561092757601f199092019160209182019101610907565b505050905090810190601f1680156109535780820380516001836020036101000a031916815260200191505b509450505050506000604051808303816000876161da5a03f192505050151561097b57610000565b5060015b9392505050565b600160a060020a038083166000908152600160209081526040808320938516835292905220545b929150505600a165627a7a7230582031edb43f3bd896ec38c1373e442bc11dbf7fa311c4203cd72dd39d67f64c25ed0029",
                "contractAddress": "0xc94a6e7776bade5da316cf6fd8c751fb0d5c3c5e",
                "cumulativeGasUsed": "1480412",
                "gasUsed": "889683",
                "confirmations": "15036229",
                "methodId": "0x60a06040",
                "functionName": ""
            },
            {
                "blockNumber": "4260142",
                "timeStamp": "1505079443",
                "hash": "0x1431bff0bbfb811cb269009c67b557a5d6cfc8508f425d6e997ecd93b8c7af6e",
                "nonce": "8",
                "blockHash": "0xf975ef975e5cdde50ad3a3ba7aa7b08adf4b173746bdd8efbe367a2fd5d67eb0",
                "transactionIndex": "123",
                "from": "0xbb0ea877a85df253ccc312b80c644da31443abfd",
                "to": "0xf9b0a119574190d2e2796662ff05e79300a0fcca",
                "value": "0",
                "gas": "51623",
                "gasPrice": "21000000000",
                "isError": "0",
                "txreceipt_status": "",
                "input": "0xa9059cbb000000000000000000000000663a25c59059df9143ba5f8084152f83e433528e0000000000000000000000000000000000000000000000000000000000989680",
                "contractAddress": "",
                "cumulativeGasUsed": "4838989",
                "gasUsed": "36623",
                "confirmations": "15036179",
                "methodId": "0xa9059cbb",
                "functionName": "transfer(address _to, uint256 _value)"
            }
        ]
    }


    const transactions = response.result;

    const results = [];

    // Loop through each day and calculate the aggregated value
    for (let i = 0; i < numberOfDays; i++) {
      const startTime = currentTime - (i + 1) * oneDayInSeconds; // Start time of the day
      const endTime = currentTime - i * oneDayInSeconds; // End time of the day

      let totalValue = 0;

      // Iterate through transactions and aggregate their values for the current day
      transactions.forEach((transaction) => {
        const timeStamp = parseInt(transaction.timeStamp);
        if (
          timeStamp >= startTime &&
          timeStamp < endTime &&
          transaction.from === from &&
          transaction.to === to
        ) {
          const value = parseFloat(transaction.value) / Math.pow(10, 15); // Divide by 10^18
          totalValue += value;
        }
      });

      // Check if the aggregated value is less than the threshold
      const isBelowThreshold = totalValue <= threshold;

      // Push the result for the current day to the results array

      if (!isBelowThreshold)
        results.push({ startTime, endTime, totalValue, isBelowThreshold });
    }

    res.status(200).json({ results });
  } catch (error) {
    console.error("Error filtering transactions:", error);
    res.status(500).json({ error: "Internal server error" });
  }
};
exports.showTransitiveTransactions = async (req, res, next) => {
  try {
    // Retrieve transactions from the database or external API
    const response = {
      status: "1",
      message: "OK",
      result: [
        {
          blockNumber: "4259813",
          timeStamp: "1708689943",
          hash: "0x607eaeeb27afe0e5bacaf020488476844ab9abcfaceafaf2cff458510de23a04",
          nonce: "464",
          blockHash:
            "0x0050d9ad58a59c894a18cf47e28e81b9ea980d2c7d46f8552f00ae3a6d5c14fc",
          transactionIndex: "31",
          from: "0x98c5c9dc6dd44d6dc07cbac11df9e0f38594cf42",
          to: "0xbb0ea877a85df253ccc312b80c644da31443abfd",
          value: "91841178427085834",
          gas: "21000",
          gasPrice: "21834513098",
          isError: "0",
          txreceipt_status: "",
          input: "0x",
          contractAddress: "",
          cumulativeGasUsed: "1237380",
          gasUsed: "21000",
          confirmations: "15036508",
          methodId: "0x",
          functionName: "",
        },
        {
          blockNumber: "4259822",
          timeStamp: "1708689944",
          hash: "0x2df037ae6da450e371ac56ec715598ee7275e491f94adb493be913f47638cab1",
          nonce: "0",
          blockHash:
            "0xf1d043750a2950ec270bee3f0f79c89d92d652576b1dfb92f00af2b63de2056a",
          transactionIndex: "26",
          from: "0xbb0ea877a85df253ccc312b80c644da31443abfd",
          to: "0xbb0ea877a85df253ccc312b80c644da31443abfe",
          value: "1000000000000000",
          gas: "250000",
          gasPrice: "4000000000",
          isError: "0",
          txreceipt_status: "",
          input:
            "0x095ea7b30000000000000000000000008d12a197cb00d4747a1fe03395095ce2a5cc681900000000000000000000000000000000000000000000000000000000000002f7",
          contractAddress: "",
          cumulativeGasUsed: "1221371",
          gasUsed: "45206",
          confirmations: "15036499",
          methodId: "0x095ea7b3",
          functionName: "approve(address _spender, uint256 _value)",
        },
        {
          blockNumber: "4259822",
          timeStamp: "1708689945",
          hash: "0xa9e0d6907374a8ca0075cec56c694cc61cbd4c5b49fa12fc30a306c23f34616e",
          nonce: "1",
          blockHash:
            "0xf1d043750a2950ec270bee3f0f79c89d92d652576b1dfb92f00af2b63de2056a",
          transactionIndex: "30",
          from: "0xbb0ea877a85df253ccc312b80c644da31443abfe",
          to: "0xbb0ea877a85df253ccc312b80c644da31443abf9",
          value: "10000000000000000",
          gas: "250000",
          gasPrice: "4000000000",
          isError: "0",
          txreceipt_status: "",
          input:
            "0x338b5dea00000000000000000000000084119cb33e8f590d75c2d6ea4e6b0741a7494eda00000000000000000000000000000000000000000000000000000000000002f7",
          contractAddress: "",
          cumulativeGasUsed: "1587746",
          gasUsed: "38357",
          confirmations: "15036499",
          methodId: "0x338b5dea",
          functionName: "depositToken(address token, uint256 amount)",
        },
      ],
    };
    const transactions = response.result;
    // console.log(transactions);
    // Build directed graph
    const graph = {};
    console.log("Number of transactions:", transactions.length); // Log the number of transactions

    if (transactions && Array.isArray(transactions)) {
      transactions.forEach(function (transaction) {
        if (
          !transaction ||
          !transaction.from ||
          !transaction.to ||
          !transaction.hash
        ) {
          return; // Skip this transaction if it's null or missing 'from', 'to', or 'hash' properties
        }
        const fromAddress = transaction.from;
        const toAddress = transaction.to;
        const hash = transaction.hash;
        if (!fromAddress || !toAddress || !hash) {
          return; // Skip this transaction if 'from', 'to', or 'hash' properties are null or undefined
        }
        if (!graph.hasOwnProperty(fromAddress)) {
          graph[fromAddress] = [];
        }
        // Push an object containing 'to' and 'hash' properties into the array for the 'from' address
        graph[fromAddress].push({ to: toAddress, hash: hash });
      });
    } else {
      console.error("Transactions is undefined or not an array");
    }
    console.log("Constructed graph:", graph); // Log the constructed graph object

    // Perform transitive closure computation
    const transitiveRelations = transitiveClosure(graph);

    // Return results
    res.status(200).json({ 
        "transactions": transactions,
        transitiveRelations
    });
  } catch (error) {
    console.error("Error showing transitive transactions:", error);
    res.status(500).json({ error: "Internal server error" });
  }
};
